# 换相与调速
By timegate 墨鸢  (Gkbytes 学习)

## 1. 换相基本原理
## 1.1 转子位置与过零检测

换相的时机只取决于转子的位置，那么转子位置如何确定？

*  光电编码盘

这个东西在工业上用得比较多。不过由于其价格比较贵，而且还要接联轴器等一堆乱七八糟的东西，分量也不轻，显然不适合我们做四轴用。

![Screenshot from 2020-03-19 17-54-31](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688454_20200319175454369_37112953.png)

* 霍耳效应器件

霍耳效应测量器件可以根据转子不同位置时的不同磁场方向分布情况，而给出 1 或 0 的输出，一般在电机的不同位置上装三个霍尔传感器，就可测出转子的位置。这就是所谓的“有感无刷电机的驱动”。

车模和船模中的电调多是使用“有感”方式，因为其电机需要频繁启动、停止、反转，而且对整套动力系统的重量也不是十分讲究，故用有感无刷电机电调是比较合适的。

* “无感”测量

利用第三相的感生电动势。无感驱动方式的优点在于省略了三个霍尔传感器，整套系统分量更轻，结构更简单。其缺点在于启动比较麻烦（这个在后文会具体分析），启动的时候可控性较差，要达到一定转速后才变得可控。不过这对航模来说倒不是个问题，航空发动机一旦转起来后，在空中是不需要停车的。

如下图，先看图(a)和图(b)，在 AB 通电期间，你会发现线圈 CC’的 C 边在图(a)中切割 N 极的磁力线并产生一个正向的感生电动势，在图(b)中确是切割 S 极的磁力线而产生一个反向的感生电动势了；C’边的情况也类似。（这里我们定义：在转子逆时针旋转时，C 边切割 N 极磁力线和 C’边切割 S 极磁力线产生的感生电动势为正；AA’和 BB’也用类似的定义）。这说明，在 AB 相通电期间，如果我们去测量线圈 CC’上的电压，会发现其间有一个从正到负的变化过程。与此类似，图(c)~图(l)中的情况也可以用相同的方法分析出来，如图 1-24 所示

![Screenshot from 2020-03-19 16-40-13](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688460_20200319180621360_1526962389.png)

![Screenshot from 2020-03-19 18-14-36](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688464_20200319181515615_914864395.png)


在 AB 相通电期间，不只是线圈 CC’上产生感生电动势，其实AA’和 BB’也在切割磁力线，也都会产生感生电动势，其电动势方向与外加的 12V 电源相反，所以叫“反向感生电动势”（BEMF）。其等效电路图见图 1-25。

![Screenshot from 2020-03-19 18-34-43](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688466_20200319183513120_1952437090.png)

从图 1-25 可以看出,线圈绕组 AA’和 BB’上产生的反电动势是很大的,两个加起来几乎略小12V。为什么呢,因为线圈绕组本身的等效电阻很小(约 0.1 欧左右),如果反电动势不大的话,端电压加载在线圈绕组等效电阻上,会产生巨大的电流,线圈非烧掉不可。

我们姑且假设在额定转速下 AA’和 BB’各产生 5.7V 的反电动势,那么它们串联起来就产生 11.4V 的反电动势,结合图 1-25 看,那么加载在等效电阻上的电压就为12 − 11.4 = 0.6 V,最终通过绕组 AB 的电流就是 0.6 / (2 × 0.1) = 3 A,看来这个假设还是比较合理的。同理,由于各绕组的结构是相同的,切割磁力线的速度也是相同的,所以线圈 CC’也应该会产生一个大小约为 5.7V 的感生电动势;不同的是:在 AB 相通电期间,CC’的感生电动势会整个换一个方向,也即所谓的“过零点”。

![Screenshot from 2020-03-20 13-40-37](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688469_20200320134111613_1557480494.png)

在图 1-24 的 t0 时刻(即图 1-20(a)的位置),为 AB 相通电刚开始时的情况,CC’产生的感生电动势的等效电路图如图 1-26(a)所示;而在图 1-24 的 t1 时刻(即图 1-20(b)的位置),为 AB 相通电快结束时的情况,CC’产生的感生电动势的等效电路图如图 1-26(b)所示。

由于中点电势值始终为 6V, CC’的线圈产生的感生电动势只能在以中点 6V 电势为基准点的基础上叠加,仍旧假设在额定转速下 CC’上会产生 5.7V 的感生电动势,那么在 t0 时刻,如果我们去测量 C 点的电压,其值应为 6 + 5.7 = 11.7 V;在 t1 时刻,C 点的电压值应为6 − 5.7 = 0.3 V。

![Screenshot from 2020-03-20 13-45-11](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688476_20200320134531961_753475674.png)

也就是说,在 AB 相通电期间,只要一直监测电机的 C 引线的电压,一旦发现它低于6V,就说明转子已转过 30°到达了 t0 和 t1 中间的位置,只要再等 30°就可以换相了。如果电调的 MCU 足够快的话,可以采用连续 AD 采样的方式来测量 C 点电压,不过貌似有点浪费,因为大部分采到的 AD 值都是没用的,我们只关心它什么时候低于 6V。这时候模拟比较器的作用就来了,它天生就是干这个活的料。比较器的联结电路图见图 1-27。一旦 C相输出电压低于 6V,比较器马上可以感知并在输出端给出一个下降沿。同理,当电机处于AC 相通电时,监测的是 B 相输出电压;当电机处于 BC 相通电时,监测的是 A 相输出电压。继续往前,当电机开始进入 BA 相通电时,C 相输出电压一开始会处于一个较低的状态(0.3V),过零事件发生时,C 相输出电压会超过 6V,也就是说,这时比较器会感知并输出一个上跳沿。接下来的 CA,CB 相通电情况也类似,不再赘述。

可能有人会说,这可是 15V 的比较器哪,单片机自带的比较器一般只支持最高 5V 的比较啊。事实上,上面这个电路图只是为了方便说明问题,在真正的实用中,会对 C 相输出电压和 6V 中点电压再加个分压电路,而且中点电压也不总是等于 6V,这个留待第二章再作详细分析,这里只要建立个概念就可以了。另外,这种检测方式中还有一个消磁问题,这个留待第三章软件部分予以分析。


## (2) 换相策略

另一个问题是,就算检测到了 C 相的过零点,那还要等转子转过 30°才可以换相,转这剩下的 30°究竟要花多少时间?

**一种方法**：近似认为转子转速在这 0°~60°的小范围区间内基本是恒定的:从 AB 相开始通电到检测出 C 相过零的前半段时间,基本等于后半段的时间。所以只要记录下前半段的时间间隔 T1,等过零事件出现后再等待相同的时间,就可以换相了。

**第二种方法**：检测到过零事件后,也不再等转子再转 30°了,立马就换相,事实上德国 MK 项目的 BL-Ctrl 电调程序就是这么干的。我们来看看这样做会有什么后果:

![Screenshot from 2020-03-20 14-15-13](https://gitee.com/kbytes/Photos_CSDN/raw/master/1584688481_20200320141632931_614243320.png)

如上图，为 AB 刚开始通电时的情况。转过 30°后,到达图(b)的位置时,检测到 C 相过零,如果此时立刻换相为 AC 导通,将成为图(c)的状态。这时,CC’线圈还处于 NS 极的交界处,此时穿过 CC’的磁感应强度为零,CC’上将不产生电磁力。也就是说此时只有线圈 AA’在出力,CC’处于出工不出力的状态。不过这个情况只是瞬时的,只要转子稍微向前再转一点,穿过 C’和 C 的磁感应强度就会开始增加,CC’就会开始出力。回忆一下图 1-19,如果梯形波电机工艺做得比较好,磁感应强度上升和下降直线比较陡峭的话,穿过 CC’的磁感应强度将很快达到最大值,期间损失的效率很小。如果电机的工艺做得一般般,上升和下降直线比较平缓的话,就会多损失一点效率,电机输出转矩的波动也会大一点。接着往下看,当转子继续转过 30°到达图(d)的位置时,一切都好,相安无事。当转子再转
过 30°到达图(e)的位置时,会检测到 B 相的过零事件,此时如果立刻换相成 BC 相通电,将成为图(f)的状态,刚导通的 BB’线圈照例会处于“星期一综合症”的状态,效率很低、出工不出力,要再过一会儿才能进入最佳工作状态。

综上所述,暴力换相的方法也是可以用的,只不过损失一点效率。除了首次换相是间隔30°外,以后的每次的换相间隔也都是 60°,转子旋转一周也是换 6 次相。